openapi: 3.0.0
info:
  title: PulgaShop - Microservicio de Publicaciones y Multimedia
  version: 2.1.2
  description: >
    API del microservicio de Publicaciones y Multimedia para el proyecto PulgaShop.  
    Este servicio gestiona la creación, edición, eliminación, obtención y moderación de publicaciones.
    Datos como precio, stock, reseñas y datos del vendedor se obtienen dinámicamente desde otros microservicios.

servers:
  - url: http://localhost:4040/api
    description: Backend local
  - url: https://localhost:4041/api
    description: Frontend local

tags:
  - name: Publicaciones
    description: Operaciones CRUD de publicaciones
  - name: Multimedia
    description: Gestión de multimedia asociada a publicaciones
  - name: Moderación
    description: Gestión de moderaciones de publicaciones

paths:
  /publicaciones:
  post:
    tags:
      - Publicaciones
    summary: Crear una nueva publicación
    description: >
      Crea una nueva publicación. El ID de la tienda y el ID del vendedor se obtienen automáticamente desde otros microservicios.
      El estado inicial siempre será `en_revision`.
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - id_producto
              - titulo
              - descripcion
            properties:
              id_producto:
                type: string
                description: ID del producto (referencia externa al microservicio de productos)
              titulo:
                type: string
                minLength: 5
                maxLength: 100
                description: Título de la publicación
              descripcion:
                type: string
                minLength: 10
                maxLength: 1000
                description: Descripción detallada de la publicación
              multimedia:
                type: array
                maxItems: 6
                description: Lista de archivos multimedia relacionados (máximo 6)
                items:
                  type: object
                  required:
                    - url
                    - orden
                  properties:
                    url:
                      type: string
                      description: URL de la imagen o video
                    cloudinary_public_id:
                      type: string
                      nullable: true
                      description: Public ID de Cloudinary para permitir su eliminación
                    orden:
                      type: integer
                      minimum: 0
                      description: Orden en el carrusel
                    tipo:
                      type: string
                      enum: [imagen, video]
                      default: imagen
                      description: Tipo de archivo multimedia
          example:
            id_producto: "producto_ABC123"
            titulo: "iPhone 13 Pro"
            descripcion: "Nuevo en caja, 256GB"
            multimedia:
              - url: "https://res.cloudinary.com/demo/image.jpg"
                cloudinary_public_id: "demo/image"
                orden: 1
                tipo: "imagen"

    responses:
      '201':
        description: Publicación creada exitosamente
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: string
                id_producto:
                  type: string
                id_vendedor:
                  type: number
                id_tienda:
                  type: number
                titulo:
                  type: string
                descripcion:
                  type: string
                estado:
                  type: string
                  example: "en_revision"
                multimedia:
                  type: array
                  items:
                    type: object
                    properties:
                      url:
                        type: string
                      cloudinary_public_id:
                        type: string
                        nullable: true
                      orden:
                        type: integer
                      tipo:
                        type: string
      '400':
        description: Datos inválidos o error al obtener tienda/vendedor
        content:
          application/json:
            schema:
              type: object
              properties:
                statusCode:
                  type: integer
                message:
                  type: string
                error:
                  type: string

    get:
  tags:
    - Publicaciones
  summary: Listar todas las publicaciones
  description: Obtiene todas las publicaciones (excepto eliminadas/inactivas por defecto) con su primera imagen (orden=0) y datos enriquecidos del producto, obtenidos desde un microservicio.
  parameters:
    - in: query
      name: includeEliminadas
      schema:
        type: boolean
        default: false
      description: Si es true, incluye publicaciones eliminadas o inactivas (todas). Si es false (por defecto), solo incluye las que tienen estado='activo'.
  responses:
    '200':
      description: Lista de publicaciones con datos enriquecidos del microservicio de productos
      content:
        application/json:
          schema:
            type: array
            items:
              type: object
              properties:
                id:
                  type: string
                  example: "pub_123abc"
                  description: ID único de la publicación.
                id_producto:
                  type: string
                  example: "prod_456def"
                  description: ID del producto asociado a esta publicación.
                titulo:
                  type: string
                  example: "iPhone 15 Pro Max 256GB"
                descripcion:
                  type: string
                  example: "Teléfono en excelente estado, sin rayones"
                multimedia:
                  type: array
                  description: Array con solo la primera imagen (orden ascendente), o array vacío si no hay.
                  maxItems: 1
                  items:
                    type: object
                    properties:
                      url:
                        type: string
                        format: uri
                        example: "https://res.cloudinary.com/demo/image/upload/v1234567890/sample.jpg"
                      # El campo 'orden' y 'id' no se incluyen en el 'select' de tu código.
                producto:
                  type: object
                  nullable: true
                  description: Datos enriquecidos del producto obtenidos del microservicio (puede ser null si falla la consulta al microservicio).
                  properties:
                    precio:
                      type: number
                      example: 899990
                    categoria:
                      type: string
                      example: "Electrónica"
                    condicion:
                      type: string
                      example: "nuevo"
                    stock: # En tu código, el parámetro 'stock' se pide, no 'cantidad'.
                      type: integer
                      example: 5
                      description: Cantidad/Stock del producto.
                    marca:
                      type: string
                      example: "Apple"
          examples:
            success:
              summary: Respuesta exitosa con productos
              value:
                - id: "pub_123abc"
                  id_producto: "prod_456def"
                  titulo: "iPhone 15 Pro Max 256GB"
                  descripcion: "Teléfono en excelente estado"
                  multimedia:
                    - url: "https://res.cloudinary.com/demo/image/upload/sample.jpg"
                  producto:
                    precio: 899990
                    categoria: "Electrónica"
                    condicion: "nuevo"
                    stock: 5
                    marca: "Apple"
            producto_null:
              summary: Publicación con producto null (microservicio falló)
              value:
                - id: "pub_125zzz"
                  id_producto: "prod_458aaa"
                  titulo: "PlayStation 5"
                  descripcion: "Nueva en caja sellada"
                  multimedia:
                    - url: "https://res.cloudinary.com/demo/image/upload/ps5.jpg"
                  producto: null
    '500':
      description: Error del servidor
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Error en listarTodas: [Detalles del error]"
              error:
                type: string
                example: "Internal Server Error"

  /publicaciones/{id}:
  get:
    tags:
      - Publicaciones
    summary: Obtener publicación por ID
    description: Obtiene los detalles completos de una publicación incluyendo multimedia, moderaciones, datos enriquecidos del producto (filtrados) y reseñas asociadas.
    parameters:
      - name: id
        in: path
        required: true
        description: ID único de la publicación
        schema:
          type: string
        example: "507f1f77bcf86cd799439011"
    responses:
      '200':
        description: Publicación encontrada y enriquecida
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: string
                id_vendedor:
                  type: string
                id_tienda:
                  type: string
                id_producto:
                  type: string
                titulo:
                  type: string
                descripcion:
                  type: string
                despacho:
                  type: string
                  enum:
                    - retiro_en_tienda
                    - envio
                    - ambos
                precio_envio:
                  type: number
                  nullable: true
                estado:
                  type: string
                  enum:
                    - borrador
                    - en_revision
                    - activo
                    - pausado
                    - vendido
                    - rechazado
                    - eliminado
                fecha_creacion:
                  type: string
                  format: date-time
                fecha_modificacion:
                  type: string
                  format: date-time
                
                multimedia:
                  type: array
                  items:
                    type: object
                    properties:
                      id:
                        type: string
                      url:
                        type: string
                      cloudinary_public_id:
                        type: string
                        nullable: true
                      orden:
                        type: integer
                      tipo:
                        type: string
                        enum: [imagen, video]
                
                moderaciones:
                  type: array
                  items:
                    type: object
                    properties:
                      id:
                        type: string
                      id_moderador:
                        type: string
                        nullable: true
                      accion:
                        type: string
                        enum: [aprobado, rechazado]
                      comentario:
                        type: string
                      fecha:
                        type: string
                        format: date-time
                
                producto:
                  type: object
                  nullable: true
                  description: Datos del producto obtenidos del microservicio (null si falla la consulta).
                  properties:
                    id:
                      type: string
                      description: ID del producto (asumiendo que el microservicio lo devuelve).
                    nombre:
                      type: string
                      example: "Teclado mecánico RGB"
                    stock:
                      type: integer
                      example: 10
                    costo:
                      type: number
                      example: 50.00
                    condicion:
                      type: string
                      example: "nuevo"
                    marca:
                      type: string
                      example: "Razer"
                    categoria:
                      type: string
                      example: "Periféricos"
                    descripcion:
                      type: string
                      example: "Descripción completa del producto en el microservicio."
                
                reseñas:
                  type: array
                  description: Lista de reseñas/ratings asociados al producto.
                  items:
                    type: object
                    properties:
                      id:
                        type: string
                        example: "rev_abc123"
                      rating:
                        type: number
                        example: 5
                      comentario:
                        type: string
                        nullable: true
                        example: "Excelente producto."
                      fecha:
                        type: string
                        format: date-time
                        
      '404':
        description: Publicación no encontrada

    put:
      tags:
        - Publicaciones
      summary: Actualizar publicación completa
      description: Actualiza los campos editables de una publicación existente
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                titulo:
                  type: string
                descripcion:
                  type: string
                despacho:
                  type: string
                  enum:
                    - retiro_en_tienda
                    - envio
                    - ambos
                precio_envio:
                  type: number
                  minimum: 0
                  nullable: true
                estado:
                  type: string
                  enum:
                    - borrador
                    - en_revision
                    - activo
                    - pausado
                    - vendido
                    - rechazado
                    - eliminado
            example:
              titulo: "iPhone 13 Pro - Actualizado"
              descripcion: "Incluye cargador y audífonos"
              despacho: "envio"
              precio_envio: 4990
              estado: "activo"
      responses:
        '200':
          description: Publicación actualizada exitosamente
        '404':
          description: Publicación no encontrada
        '400':
          description: Datos inválidos

    delete:
      tags:
        - Publicaciones
      summary: Eliminar publicación (soft delete)
      description: Cambia el estado de la publicación a "eliminado" sin borrarla de la base de datos
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Publicación eliminada exitosamente
        '404':
          description: Publicación no encontrada
        '400':
          description: La publicación ya está eliminada

  /publicaciones/tienda/{id_tienda}:
    get:
      tags:
        - Publicaciones
      summary: Listar publicaciones por tienda
      description: Obtiene todas las publicaciones asociadas a una tienda específica, incluyendo multimedia, moderaciones y el producto correspondiente.
      parameters:
        - name: id_tienda
          in: path
          required: true
          description: ID de la tienda
          schema:
            type: string
      responses:
        '200':
          description: Lista de publicaciones de la tienda
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    id_vendedor:
                      type: string
                    id_tienda:
                      type: string
                    id_producto:
                      type: string
                    titulo:
                      type: string
                    descripcion:
                      type: string
                    despacho:
                      type: string
                      enum:
                        - retiro_en_tienda
                        - envio
                        - ambos
                    precio_envio:
                      type: number
                      nullable: true
                    estado:
                      type: string
                      enum:
                        - borrador
                        - en_revision
                        - activo
                        - pausado
                        - vendido
                        - rechazado
                        - eliminado
                    fecha_creacion:
                      type: string
                      format: date-time
                    fecha_modificacion:
                      type: string
                      format: date-time
                    multimedia:
                      type: array
                      items:
                        type: object
                        properties:
                          id:
                            type: string
                          url:
                            type: string
                          cloudinary_public_id:
                            type: string
                            nullable: true
                          orden:
                            type: integer
                          tipo:
                            type: string
                            enum: [imagen, video]
                            default: imagen
                    moderaciones:
                      type: array
                      items:
                        type: object
                        properties:
                          id:
                            type: string
                          id_publicacion:
                            type: string
                          motivo:
                            type: string
                          estado:
                            type: string
                          fecha:
                            type: string
                            format: date-time
                    producto:
                      type: object
                      nullable: true
                      description: >
                        Información del producto asociada a la publicación,
                        obtenida del microservicio de productos. Será null si no se
                        pudo recuperar.
        '404':
          description: No hay publicaciones asociadas a la tienda especificada
          content:
            application/json:
              schema:
                type: object
                properties:
                  statusCode:
                    type: integer
                    example: 404
                  message:
                    type: string
                    example: No hay publicaciones para la tienda {id_tienda}
                  error:
                    type: string
                    example: Not Found

  /publicaciones/eliminar/{id}:
    delete:
      tags:
        - Publicaciones
      summary: Eliminar publicación permanentemente (hard delete)
      description: Elimina físicamente la publicación de la base de datos. Esta acción es irreversible.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Publicación eliminada completamente
        '404':
          description: Publicación no encontrada

  /publicaciones/{id}/estado:
    patch:
      tags:
        - Publicaciones
      summary: Cambiar estado de publicación
      description: Actualiza únicamente el estado de una publicación
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - estado
              properties:
                estado:
                  type: string
                  enum:
                    - borrador
                    - en_revision
                    - activo
                    - pausado
                    - vendido
                    - rechazado
                    - eliminado
            example:
              estado: "activo"
      responses:
        '200':
          description: Estado actualizado exitosamente
        '404':
          description: Publicación no encontrada

  /publicaciones/{id}/multimedia:
    post:
      tags:
        - Multimedia
      summary: Agregar multimedia a publicación
      description: Agrega una imagen o video a una publicación existente
      parameters:
        - name: id
          in: path
          required: true
          description: ID de la publicación
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - url
                - orden
              properties:
                url:
                  type: string
                cloudinary_public_id:
                  type: string
                  nullable: true
                orden:
                  type: integer
                tipo:
                  type: string
                  enum: [imagen, video]
                  default: imagen
            example:
              url: "https://res.cloudinary.com/demo/image2.jpg"
              cloudinary_public_id: "demo/image2"
              orden: 2
              tipo: "imagen"
      responses:
        '201':
          description: Multimedia agregada exitosamente
        '404':
          description: Publicación no encontrada

  /publicaciones/multimedia/{multimediaId}:
    delete:
      tags:
        - Multimedia
      summary: Eliminar multimedia
      description: Elimina una imagen o video de una publicación
      parameters:
        - name: multimediaId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Multimedia eliminada exitosamente
        '404':
          description: Multimedia no encontrada

  /publicaciones/{id}/moderacion:
    post:
      tags:
        - Moderación
      summary: Agregar moderación a publicación
      description: Registra una acción de moderación sobre una publicación
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - accion
                - motivo
              properties:
                id_moderador:
                  type: string
                  nullable: true
                tipo_moderacion:
                  type: string
                  enum: [automatica, manual]
                accion:
                  type: string
                  enum: [aprobado, rechazado]
                motivo:
                  type: string
                palabras_detectadas:
                  type: array
                  items:
                    type: string
                  nullable: true
                contenido_detectado:
                  type: array
                  items:
                    type: string
                  nullable: true
            example:
              id_moderador: "mod_001"
              tipo_moderacion: "manual"
              accion: "rechazado"
              motivo: "Las imágenes no cumplen con las políticas de la plataforma"
              palabras_detectadas: []
              contenido_detectado: []
      responses:
        '201':
          description: Moderación registrada exitosamente
        '404':
          description: Publicación no encontrada

  /moderacion/publicacion/{id}:
    post:
      tags:
        - Moderación
      summary: Moderar automáticamente una publicación
      description: >
        Analiza el título y la descripción de una publicación utilizando el motor
        interno de detección de contenido inapropiado. Registra la moderación y
        actualiza el estado de la publicación a 'rechazado' o 'activo'.
      parameters:
        - name: id
          in: path
          required: true
          description: ID de la publicación a moderar
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                titulo:
                  type: string
                descripcion:
                  type: string
      responses:
        '201':
          description: Resultado de la moderación automática
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  id_publicacion:
                    type: string
                  tipo_moderacion:
                    type: string
                    enum: [automatica, manual]
                  accion:
                    type: string
                    enum: [aprobado, rechazado]
                  motivo:
                    type: string
                  palabras_detectadas:
                    type: array
                    items:
                      type: string
                  contenido_detectado:
                    type: array
                    items:
                      type: string
        '404':
          description: Publicación no encontrada

  /moderacion/publicacion/{id}/historial:
    get:
      tags:
        - Moderación
      summary: Obtener historial de moderación
      description: Devuelve todas las moderaciones realizadas sobre la publicación, ordenadas por fecha descendente.
      parameters:
        - name: id
          in: path
          required: true
          description: ID de la publicación
          schema:
            type: string
      responses:
        '200':
          description: Historial de moderaciones de la publicación
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    id_publicacion:
                      type: string
                    tipo_moderacion:
                      type: string
                    accion:
                      type: string
                    motivo:
                      type: string
                    palabras_detectadas:
                      type: array
                      items:
                        type: string
                    contenido_detectado:
                      type: array
                      items:
                        type: string
                    fecha:
                      type: string
                      format: date-time
        '404':
          description: No existe historial para esta publicación

  /publicaciones/cleanup/manual:
    post:
      tags:
        - Publicaciones - Mantenimiento
      summary: Ejecutar limpieza manual de publicaciones eliminadas
      description: |
        Ejecuta manualmente el proceso de limpieza que normalmente se ejecuta automáticamente a las 2:00 AM.
        Elimina permanentemente publicaciones que llevan más de 30 días en estado "eliminado".
        
        **Proceso de limpieza:**
        1. Busca publicaciones con estado "eliminado" y fecha_eliminacion > 30 días
        2. Elimina las imágenes asociadas de Cloudinary
        3. Elimina permanentemente la publicación de la base de datos (incluyendo multimedia y moderaciones por CASCADE)
        
        **⚠️ ADVERTENCIA:** Esta acción es IRREVERSIBLE. Las publicaciones eliminadas no se pueden recuperar.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Limpieza ejecutada correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Limpieza ejecutada correctamente"
                  publicacionesEliminadas:
                    type: integer
                    example: 15
                    description: Cantidad de publicaciones eliminadas permanentemente
              examples:
                con_publicaciones:
                  summary: Se eliminaron publicaciones
                  value:
                    message: "Limpieza ejecutada correctamente"
                    publicacionesEliminadas: 15
                    detalles: "15 publicaciones y 45 imágenes eliminadas permanentemente"
                
                sin_publicaciones:
                  summary: No había publicaciones para eliminar
                  value:
                    message: "Limpieza ejecutada correctamente"
                    publicacionesEliminadas: 0
                    detalles: "No hay publicaciones para limpiar"

        '401':
          description: No autorizado - Se requiere autenticación de administrador
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Acceso denegado"
                  error:
                    type: string
                    example: "Unauthorized"

        '403':
          description: Prohibido - Solo administradores pueden ejecutar esta acción
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "No tienes permisos para ejecutar esta acción"
                  error:
                    type: string
                    example: "Forbidden"

        '500':
          description: Error del servidor durante la limpieza
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Error al ejecutar limpieza"
                  error:
                    type: string
                    example: "Internal Server Error"

  /publicaciones/cleanup/stats:
    get:
      tags:
        - Publicaciones - Mantenimiento
      summary: Obtener estadísticas de publicaciones pendientes de limpieza
      description: |
        Muestra información sobre publicaciones que están marcadas como eliminadas y cuántas son elegibles para limpieza permanente (más de 30 días eliminadas).
        
        Útil para:
        - Monitorear el estado de las publicaciones eliminadas
        - Ver cuántas publicaciones se limpiarán en la próxima ejecución automática
        - Verificar el espacio que se liberará en Cloudinary
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Estadísticas de limpieza
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalEliminadas:
                    type: integer
                    description: Total de publicaciones en estado "eliminado"
                    example: 45
                  elegiblesParaLimpieza:
                    type: integer
                    description: Publicaciones eliminadas hace más de 30 días (se eliminarán en próxima limpieza)
                    example: 15
                  imagenesAEliminar:
                    type: integer
                    description: Total de imágenes en Cloudinary que se eliminarán
                    example: 48
                  proximaLimpieza:
                    type: string
                    format: date-time
                    description: Fecha y hora de la próxima ejecución automática (2:00 AM)
                    example: "2024-11-28T02:00:00.000Z"
                  publicacionesDetalle:
                    type: array
                    description: Lista detallada de publicaciones elegibles para limpieza
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          example: "pub_123abc"
                        titulo:
                          type: string
                          example: "iPhone 15 Pro"
                        fecha_eliminacion:
                          type: string
                          format: date-time
                          example: "2024-09-15T10:30:00.000Z"
                        dias_eliminada:
                          type: integer
                          example: 73
                        cantidad_imagenes:
                          type: integer
                          example: 5
              examples:
                con_publicaciones:
                  summary: Hay publicaciones pendientes de limpieza
                  value:
                    totalEliminadas: 45
                    elegiblesParaLimpieza: 15
                    imagenesAEliminar: 48
                    proximaLimpieza: "2024-11-28T02:00:00.000Z"
                    publicacionesDetalle:
                      - id: "pub_123abc"
                        titulo: "iPhone 15 Pro"
                        fecha_eliminacion: "2024-09-15T10:30:00.000Z"
                        dias_eliminada: 73
                        cantidad_imagenes: 5
                      - id: "pub_456def"
                        titulo: "PlayStation 5"
                        fecha_eliminacion: "2024-09-20T14:20:00.000Z"
                        dias_eliminada: 68
                        cantidad_imagenes: 3
                
                sin_publicaciones:
                  summary: No hay publicaciones para limpiar
                  value:
                    totalEliminadas: 10
                    elegiblesParaLimpieza: 0
                    imagenesAEliminar: 0
                    proximaLimpieza: "2024-11-28T02:00:00.000Z"
                    publicacionesDetalle: []

        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Acceso denegado"

        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Error al obtener estadísticas"

  components:
    securitySchemes:
      bearerAuth:
        type: http
        scheme: bearer
        bearerFormat: JWT
        description: Token JWT de autenticación de administrador