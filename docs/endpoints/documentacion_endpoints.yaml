openapi: 3.0.0
info:
  title: PulgaShop - Microservicio de Publicaciones y Multimedia
  version: 2.1.2
  description: >
    API del microservicio de Publicaciones y Multimedia para el proyecto PulgaShop.  
    Este servicio gestiona la creación, edición, eliminación, obtención y moderación de publicaciones.
    Datos como precio, stock, reseñas y datos del vendedor se obtienen dinámicamente desde otros microservicios.

servers:
  - url: http://localhost:4040/api
    description: Servidor de desarrollo

tags:
  - name: Publicaciones
    description: Operaciones CRUD de publicaciones
  - name: Multimedia
    description: Gestión de multimedia asociada a publicaciones
  - name: Moderación
    description: Gestión de moderaciones de publicaciones

paths:
  /publicaciones:
    post:
      tags:
        - Publicaciones
      summary: Crear una nueva publicación
      description: Crea una publicación con estado inicial "en_revision"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id_vendedor
                - id_tienda
                - id_producto
                - titulo
                - descripcion
              properties:
                id_vendedor:
                  type: string
                  description: ID del vendedor (referencia externa)
                id_producto:
                  type: string
                  description: ID del producto (referencia externa desde el microservicio de productos)
                titulo:
                  type: string
                  description: Título de la publicación
                  minLength: 5
                  maxLength: 100
                descripcion:
                  type: string
                  description: Descripción detallada
                  minLength: 10
                  maxLength: 1000
                despacho:
                  type: string
                  enum:
                    - retiro_en_tienda
                    - envio
                    - ambos
                  default: retiro_en_tienda
                  description: Método de entrega disponible para la publicación
                precio_envio:
                  type: number
                  minimum: 0
                  nullable: true
                  description: Costo del envío si aplica
                multimedia:
                  type: array
                  maxItems: 6
                  description: Lista de archivos multimedia relacionados (máximo 6)
                  items:
                    type: object
                    required:
                      - url
                      - orden
                    properties:
                      url:
                        type: string
                      cloudinary_public_id:
                        type: string
                        nullable: true
                        description: Public ID de Cloudinary para eliminación
                      orden:
                        type: integer
                        minimum: 0
                      tipo:
                        type: string
                        enum: [imagen, video]
                        default: imagen
            example:
              id_vendedor: "vendedor_001"
              id_tienda: "tienda_123"
              id_producto: "producto_ABC123"
              titulo: "iPhone 13 Pro"
              descripcion: "Nuevo en caja, 256GB"
              despacho: "envio"
              precio_envio: 5990
              multimedia:
                - url: "https://res.cloudinary.com/demo/image.jpg"
                  cloudinary_public_id: "demo/image"
                  orden: 1
                  tipo: "imagen"

      responses:
        '201':
          description: Publicación creada exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  mensaje:
                    type: string
                    example: "Publicación creada exitosamente"
                  id:
                    type: string
                  id_producto:
                    type: string
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                type: object
                properties:
                  statusCode:
                    type: integer
                  message:
                    type: string
                  error:
                    type: string

    get:
      tags:
        - Publicaciones
      summary: Listar todas las publicaciones
      description: Obtiene todas las publicaciones (excepto eliminadas por defecto) con su primera imagen y datos del producto
      parameters:
        - in: query
          name: includeEliminadas
          schema:
            type: boolean
            default: false
          description: Si es true, incluye publicaciones eliminadas
      responses:
        '200':
          description: Lista de publicaciones con datos enriquecidos del microservicio de productos
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      example: "pub_123abc"
                    id_producto:
                      type: string
                      example: "prod_456def"
                    titulo:
                      type: string
                      example: "iPhone 15 Pro Max 256GB"
                    descripcion:
                      type: string
                      example: "Teléfono en excelente estado, sin rayones"
                    multimedia:
                      type: array
                      description: Array con solo la primera imagen (ordenada por 'orden')
                      maxItems: 1
                      items:
                        type: object
                        properties:
                          id:
                            type: string
                            example: "img_789ghi"
                          url:
                            type: string
                            format: uri
                            example: "https://res.cloudinary.com/demo/image/upload/v1234567890/sample.jpg"
                          orden:
                            type: integer
                            example: 0
                    producto:
                      type: object
                      nullable: true
                      description: Datos del producto obtenidos del microservicio (puede ser null si falla la consulta)
                      properties:
                        precio:
                          type: number
                          example: 899990
                        categoria:
                          type: string
                          example: "Electrónica"
                        condicion:
                          type: string
                          example: "nuevo"
                        cantidad:
                          type: integer
                          example: 5
                        marca:
                          type: string
                          example: "Apple"
              examples:
                success:
                  summary: Respuesta exitosa con productos
                  value:
                    - id: "pub_123abc"
                      id_producto: "prod_456def"
                      titulo: "iPhone 15 Pro Max 256GB"
                      descripcion: "Teléfono en excelente estado"
                      multimedia:
                        - id: "img_789ghi"
                          url: "https://res.cloudinary.com/demo/image/upload/sample.jpg"
                          orden: 0
                      producto:
                        precio: 899990
                        categoria: "Electrónica"
                        condicion: "nuevo"
                        cantidad: 5
                        marca: "Apple"
                    - id: "pub_124xyz"
                      id_producto: "prod_457uvw"
                      titulo: "Zapatillas Nike Air Max"
                      descripcion: "Talla 42, usadas pero en buen estado"
                      multimedia:
                        - id: "img_790jkl"
                          url: "https://res.cloudinary.com/demo/image/upload/shoes.jpg"
                          orden: 0
                      producto:
                        precio: 45990
                        categoria: "Calzado"
                        condicion: "usado"
                        cantidad: 1
                        marca: "Nike"
                
                producto_null:
                  summary: Publicación con producto null (microservicio falló)
                  value:
                    - id: "pub_125zzz"
                      id_producto: "prod_458aaa"
                      titulo: "PlayStation 5"
                      descripcion: "Nueva en caja sellada"
                      multimedia:
                        - id: "img_791mno"
                          url: "https://res.cloudinary.com/demo/image/upload/ps5.jpg"
                          orden: 0
                      producto: null

                sin_multimedia:
                  summary: Publicación sin imágenes
                  value:
                    - id: "pub_126bbb"
                      id_producto: "prod_459ccc"
                      titulo: "Bicicleta de montaña"
                      descripcion: "Rodado 29, frenos hidráulicos"
                      multimedia: []
                      producto:
                        precio: 250000
                        categoria: "Deportes"
                        condicion: "usado"
                        cantidad: 1
                        marca: "Trek"

        '500':
          description: Error del servidor
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Error al listar publicaciones"
                  error:
                    type: string
                    example: "Internal Server Error"

  /publicaciones/{id}:
    get:
      tags:
        - Publicaciones
      summary: Obtener publicación por ID
      description: Obtiene los detalles completos de una publicación incluyendo multimedia y moderaciones
      parameters:
        - name: id
          in: path
          required: true
          description: ID único de la publicación
          schema:
            type: string
          example: "507f1f77bcf86cd799439011"
      responses:
        '200':
          description: Publicación encontrada
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  id_vendedor:
                    type: string
                  id_tienda:
                    type: string
                  id_producto:
                    type: string
                  titulo:
                    type: string
                  descripcion:
                    type: string
                  despacho:
                    type: string
                    enum:
                      - retiro_en_tienda
                      - envio
                      - ambos
                  precio_envio:
                    type: number
                    nullable: true
                  estado:
                    type: string
                    enum:
                      - borrador
                      - en_revision
                      - activo
                      - pausado
                      - vendido
                      - rechazado
                      - eliminado
                  fecha_creacion:
                    type: string
                    format: date-time
                  fecha_modificacion:
                    type: string
                    format: date-time
                  multimedia:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        url:
                          type: string
                        cloudinary_public_id:
                          type: string
                          nullable: true
                        orden:
                          type: integer
                        tipo:
                          type: string
                          enum: [imagen, video]
                  moderaciones:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        id_moderador:
                          type: string
                          nullable: true
                        accion:
                          type: string
                          enum: [aprobado, rechazado]
                        comentario:
                          type: string
                        fecha:
                          type: string
                          format: date-time
        '404':
          description: Publicación no encontrada

    put:
      tags:
        - Publicaciones
      summary: Actualizar publicación completa
      description: Actualiza los campos editables de una publicación existente
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                titulo:
                  type: string
                descripcion:
                  type: string
                despacho:
                  type: string
                  enum:
                    - retiro_en_tienda
                    - envio
                    - ambos
                precio_envio:
                  type: number
                  minimum: 0
                  nullable: true
                estado:
                  type: string
                  enum:
                    - borrador
                    - en_revision
                    - activo
                    - pausado
                    - vendido
                    - rechazado
                    - eliminado
            example:
              titulo: "iPhone 13 Pro - Actualizado"
              descripcion: "Incluye cargador y audífonos"
              despacho: "envio"
              precio_envio: 4990
              estado: "activo"
      responses:
        '200':
          description: Publicación actualizada exitosamente
        '404':
          description: Publicación no encontrada
        '400':
          description: Datos inválidos

    delete:
      tags:
        - Publicaciones
      summary: Eliminar publicación (soft delete)
      description: Cambia el estado de la publicación a "eliminado" sin borrarla de la base de datos
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Publicación eliminada exitosamente
        '404':
          description: Publicación no encontrada
        '400':
          description: La publicación ya está eliminada

  /publicaciones/tienda/{id_tienda}:
    get:
      tags:
        - Publicaciones
      summary: Listar publicaciones por tienda
      description: Obtiene todas las publicaciones asociadas a una tienda específica, incluyendo multimedia, moderaciones y el producto correspondiente.
      parameters:
        - name: id_tienda
          in: path
          required: true
          description: ID de la tienda
          schema:
            type: string
      responses:
        '200':
          description: Lista de publicaciones de la tienda
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    id_vendedor:
                      type: string
                    id_tienda:
                      type: string
                    id_producto:
                      type: string
                    titulo:
                      type: string
                    descripcion:
                      type: string
                    despacho:
                      type: string
                      enum:
                        - retiro_en_tienda
                        - envio
                        - ambos
                    precio_envio:
                      type: number
                      nullable: true
                    estado:
                      type: string
                      enum:
                        - borrador
                        - en_revision
                        - activo
                        - pausado
                        - vendido
                        - rechazado
                        - eliminado
                    fecha_creacion:
                      type: string
                      format: date-time
                    fecha_modificacion:
                      type: string
                      format: date-time
                    multimedia:
                      type: array
                      items:
                        type: object
                        properties:
                          id:
                            type: string
                          url:
                            type: string
                          cloudinary_public_id:
                            type: string
                            nullable: true
                          orden:
                            type: integer
                          tipo:
                            type: string
                            enum: [imagen, video]
                            default: imagen
                    moderaciones:
                      type: array
                      items:
                        type: object
                        properties:
                          id:
                            type: string
                          id_publicacion:
                            type: string
                          motivo:
                            type: string
                          estado:
                            type: string
                          fecha:
                            type: string
                            format: date-time
                    producto:
                      type: object
                      nullable: true
                      description: >
                        Información del producto asociada a la publicación,
                        obtenida del microservicio de productos. Será null si no se
                        pudo recuperar.
        '404':
          description: No hay publicaciones asociadas a la tienda especificada
          content:
            application/json:
              schema:
                type: object
                properties:
                  statusCode:
                    type: integer
                    example: 404
                  message:
                    type: string
                    example: No hay publicaciones para la tienda {id_tienda}
                  error:
                    type: string
                    example: Not Found

  /publicaciones/eliminar/{id}:
    delete:
      tags:
        - Publicaciones
      summary: Eliminar publicación permanentemente (hard delete)
      description: Elimina físicamente la publicación de la base de datos. Esta acción es irreversible.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Publicación eliminada completamente
        '404':
          description: Publicación no encontrada

  /publicaciones/{id}/estado:
    patch:
      tags:
        - Publicaciones
      summary: Cambiar estado de publicación
      description: Actualiza únicamente el estado de una publicación
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - estado
              properties:
                estado:
                  type: string
                  enum:
                    - borrador
                    - en_revision
                    - activo
                    - pausado
                    - vendido
                    - rechazado
                    - eliminado
            example:
              estado: "activo"
      responses:
        '200':
          description: Estado actualizado exitosamente
        '404':
          description: Publicación no encontrada

  /publicaciones/{id}/multimedia:
    post:
      tags:
        - Multimedia
      summary: Agregar multimedia a publicación
      description: Agrega una imagen o video a una publicación existente
      parameters:
        - name: id
          in: path
          required: true
          description: ID de la publicación
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - url
                - orden
              properties:
                url:
                  type: string
                cloudinary_public_id:
                  type: string
                  nullable: true
                orden:
                  type: integer
                tipo:
                  type: string
                  enum: [imagen, video]
                  default: imagen
            example:
              url: "https://res.cloudinary.com/demo/image2.jpg"
              cloudinary_public_id: "demo/image2"
              orden: 2
              tipo: "imagen"
      responses:
        '201':
          description: Multimedia agregada exitosamente
        '404':
          description: Publicación no encontrada

  /publicaciones/multimedia/{multimediaId}:
    delete:
      tags:
        - Multimedia
      summary: Eliminar multimedia
      description: Elimina una imagen o video de una publicación
      parameters:
        - name: multimediaId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Multimedia eliminada exitosamente
        '404':
          description: Multimedia no encontrada

  /publicaciones/{id}/moderacion:
    post:
      tags:
        - Moderación
      summary: Agregar moderación a publicación
      description: Registra una acción de moderación sobre una publicación
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - accion
                - motivo
              properties:
                id_moderador:
                  type: string
                  nullable: true
                tipo_moderacion:
                  type: string
                  enum: [automatica, manual]
                accion:
                  type: string
                  enum: [aprobado, rechazado]
                motivo:
                  type: string
                palabras_detectadas:
                  type: array
                  items:
                    type: string
                  nullable: true
                contenido_detectado:
                  type: array
                  items:
                    type: string
                  nullable: true
            example:
              id_moderador: "mod_001"
              tipo_moderacion: "manual"
              accion: "rechazado"
              motivo: "Las imágenes no cumplen con las políticas de la plataforma"
              palabras_detectadas: []
              contenido_detectado: []
      responses:
        '201':
          description: Moderación registrada exitosamente
        '404':
          description: Publicación no encontrada

  /moderacion/publicacion/{id}:
    post:
      tags:
        - Moderación
      summary: Moderar automáticamente una publicación
      description: >
        Analiza el título y la descripción de una publicación utilizando el motor
        interno de detección de contenido inapropiado. Registra la moderación y
        actualiza el estado de la publicación a 'rechazado' o 'activo'.
      parameters:
        - name: id
          in: path
          required: true
          description: ID de la publicación a moderar
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                titulo:
                  type: string
                descripcion:
                  type: string
      responses:
        '201':
          description: Resultado de la moderación automática
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  id_publicacion:
                    type: string
                  tipo_moderacion:
                    type: string
                    enum: [automatica, manual]
                  accion:
                    type: string
                    enum: [aprobado, rechazado]
                  motivo:
                    type: string
                  palabras_detectadas:
                    type: array
                    items:
                      type: string
                  contenido_detectado:
                    type: array
                    items:
                      type: string
        '404':
          description: Publicación no encontrada

  /moderacion/publicacion/{id}/historial:
    get:
      tags:
        - Moderación
      summary: Obtener historial de moderación
      description: Devuelve todas las moderaciones realizadas sobre la publicación, ordenadas por fecha descendente.
      parameters:
        - name: id
          in: path
          required: true
          description: ID de la publicación
          schema:
            type: string
      responses:
        '200':
          description: Historial de moderaciones de la publicación
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    id_publicacion:
                      type: string
                    tipo_moderacion:
                      type: string
                    accion:
                      type: string
                    motivo:
                      type: string
                    palabras_detectadas:
                      type: array
                      items:
                        type: string
                    contenido_detectado:
                      type: array
                      items:
                        type: string
                    fecha:
                      type: string
                      format: date-time
        '404':
          description: No existe historial para esta publicación

